<!DOCTYPE html>
<html dir="rtl" lang="ar">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Dashboard - L'Aura Vital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800&display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }

        .glass {
            background: rgba(26, 26, 26, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0c0a09;
        }

        ::-webkit-scrollbar-thumb {
            background: #27272a;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3f3f46;
        }
    </style>
</head>

<body class="bg-zinc-950 text-zinc-100 min-h-screen">

    <!-- Auth Overlay -->
    <div id="authOverlay" class="fixed inset-0 z-[100] bg-zinc-950 flex items-center justify-center p-4">
        <div class="max-w-md w-full glass p-8 rounded-3xl space-y-6 text-center">
            <div class="w-20 h-20 bg-accent/10 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-icons-round text-zinc-400 text-4xl">lock</span>
            </div>
            <h2 class="text-2xl font-black tracking-widest uppercase text-white">L'AURA VITAL ADMIN</h2>
            <p class="text-zinc-500 text-sm font-bold">يرجى إدخال كلمة المرور للوصول إلى لوحة التحكم</p>
            <input type="password" id="adminPass"
                class="w-full bg-zinc-900 border-zinc-800 rounded-xl p-4 text-center text-white focus:ring-2 focus:ring-zinc-700 outline-none transition-all"
                placeholder="••••••••" />
            <button onclick="checkAuth()"
                class="w-full bg-white text-black font-black py-4 rounded-xl hover:bg-zinc-200 transition-all uppercase tracking-widest">دخول</button>
            <p id="authError" class="text-red-500 text-xs font-bold hidden">كلمة مرور غير صحيحة!</p>
        </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="hidden">
        <nav class="sticky top-0 z-50 glass border-b border-white/5 px-6 h-20 flex items-center justify-between">
            <span class="text-xl font-black tracking-[0.2em] text-white">L'AURA VITAL DASHBOARD</span>
            <div class="flex items-center gap-4">
                <button onclick="logout()"
                    class="text-zinc-400 hover:text-white transition-all flex items-center gap-2 font-bold text-sm">
                    <span>تسجيل الخروج</span>
                    <span class="material-icons-round text-lg">logout</span>
                </button>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto p-6 space-y-10">
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass p-8 rounded-3xl space-y-4">
                    <p class="text-zinc-500 text-xs font-black uppercase tracking-widest">إجمالي الطلبات</p>
                    <div class="flex justify-between items-end">
                        <h3 id="totalLeads" class="text-4xl font-black text-white">0</h3>
                        <span class="text-green-500 flex items-center gap-1 text-xs font-bold">
                            <span class="material-icons-round text-sm">trending_up</span> +12%
                        </span>
                    </div>
                </div>
                <div class="glass p-8 rounded-3xl space-y-4">
                    <p class="text-zinc-500 text-xs font-black uppercase tracking-widest">طلبات اليوم</p>
                    <div class="flex justify-between items-end">
                        <h3 id="todayLeads" class="text-4xl font-black text-white">0</h3>
                        <span
                            class="bg-zinc-800 px-3 py-1 rounded-full text-[10px] text-zinc-400 font-black">جدید</span>
                    </div>
                </div>
                <div class="glass p-8 rounded-3xl space-y-4">
                    <p class="text-zinc-500 text-xs font-black uppercase tracking-widest">معدل التحويل</p>
                    <div class="flex justify-between items-end">
                        <h3 class="text-4xl font-black text-white">68%</h3>
                        <div class="w-24 h-2 bg-zinc-800 rounded-full overflow-hidden">
                            <div class="w-[68%] h-full bg-white"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leads Management -->
            <div class="glass rounded-3xl overflow-hidden">
                <div class="p-8 border-b border-white/5 flex flex-col md:flex-row gap-6 justify-between items-center">
                    <div>
                        <h2 class="text-xl font-black text-white">قائمة الطلبات</h2>
                        <p class="text-zinc-500 text-xs font-bold mt-1">إدارة الطلبات الواردة من الموقع</p>
                    </div>
                    <div class="flex gap-4">
                        <div class="relative">
                            <span
                                class="material-icons-round absolute left-4 top-1/2 -translate-y-1/2 text-zinc-500">search</span>
                            <input onkeyup="filterLeads(this.value)" type="text"
                                class="bg-zinc-900 border-none rounded-xl pl-12 pr-4 py-3 text-sm focus:ring-1 focus:ring-zinc-700 w-64 outline-none"
                                placeholder="بحث بالاسم أو الهاتف..." />
                        </div>
                        <button onclick="exportJSON()"
                            class="bg-zinc-800 hover:bg-zinc-700 p-3 rounded-xl transition-all" title="تصدير JSON">
                            <span class="material-icons-round text-zinc-300">download</span>
                        </button>
                        <button onclick="clearLeads()"
                            class="bg-red-900/20 hover:bg-red-900/40 p-3 rounded-xl transition-all" title="مسح الكل">
                            <span class="material-icons-round text-red-500">delete_sweep</span>
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-right">
                        <thead>
                            <tr
                                class="text-zinc-500 text-xs font-black uppercase tracking-widest border-b border-white/5">
                                <th class="p-6">التاريخ</th>
                                <th class="p-6">الاسم الكامل</th>
                                <th class="p-6">رقم الهاتف</th>
                                <th class="p-6">المدينة</th>
                                <th class="p-6">الحالة</th>
                                <th class="p-6 text-left">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="leadsTableBody">
                            <!-- Data injected here -->
                        </tbody>
                    </table>
                </div>

                <div id="emptyState" class="hidden py-32 text-center space-y-4">
                    <span class="material-icons-round text- zinc-800 text-8xl">inbox</span>
                    <p class="text-zinc-500 font-bold">لا يوجد طلبات في الوقت الحالي</p>
                </div>
            </div>
        </main>
    </div>

    <script>
        const ADMIN_PASS = 'admin123';
        let allLeads = [];

        // Simple Auth Logic
        function checkAuth() {
            const pass = document.getElementById('adminPass').value;
            if (pass === ADMIN_PASS) {
                document.getElementById('authOverlay').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                sessionStorage.setItem('isAdmin', 'true');
                loadLeads();
            } else {
                document.getElementById('authError').classList.remove('hidden');
            }
        }

        // Check if already logged in
        if (sessionStorage.getItem('isAdmin') === 'true') {
            document.getElementById('authOverlay').classList.add('hidden');
            document.getElementById('mainContent').classList.remove('hidden');
            document.addEventListener('DOMContentLoaded', loadLeads);
        }

        function logout() {
            sessionStorage.removeItem('isAdmin');
            location.reload();
        }

        // Leads Management
        function loadLeads() {
            const tbody = document.getElementById('leadsTableBody');
            tbody.innerHTML = '<tr><td colspan="6" class="p-12 text-center text-zinc-500 font-bold">جاري تحميل البيانات...</td></tr>';

            fetch('https://spaceseller.app.n8n.cloud/webhook-test/get-data')
                .then(response => response.json())
                .then(data => {
                    // n8n might return the array directly or wrapped in an object
                    allLeads = Array.isArray(data) ? data : (data.leads || []);
                    renderLeads(allLeads);
                    updateStats();
                })
                .catch(error => {
                    console.error('Error fetching leads:', error);
                    tbody.innerHTML = '<tr><td colspan="6" class="p-12 text-center text-red-500 font-bold">حدث خطأ أثناء تحميل البيانات</td></tr>';
                });
        }

        function renderLeads(leads) {
            const tbody = document.getElementById('leadsTableBody');
            const emptyState = document.getElementById('emptyState');

            if (leads.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            tbody.innerHTML = leads.map(lead => `
                <tr class="border-b border-white/5 hover:bg-white/[0.02] transition-colors group">
                    <td class="p-6 text-zinc-400 text-sm font-medium">${lead.timestamp || '—'}</td>
                    <td class="p-6 font-black text-white">${lead.name || lead.fullName || '—'}</td>
                    <td class="p-6 text-zinc-300 font-mono tracking-wider">${lead.phone || lead.phoneNumber || '—'}</td>
                    <td class="p-6 text-zinc-400 font-bold">${lead.city || '—'}</td>
                    <td class="p-6">
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${(lead.status || 'جديد') === 'جديد' ? 'bg-zinc-800 text-zinc-400' : 'bg-green-900/20 text-green-500'}">
                            ${lead.status || 'جديد'}
                        </span>
                    </td>
                    <td class="p-6 text-left">
                        <button onclick="toggleStatus(${lead.id || lead.row_number})" class="text-zinc-600 hover:text-white transition-all">
                            <span class="material-icons-round text-xl">done_all</span>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalLeads').innerText = allLeads.length;
            const today = new Date().toLocaleDateString('ar-MA', { timeZone: 'Africa/Casablanca' });
            const todayCount = allLeads.filter(l => (l.timestamp || '').includes(today)).length;
            document.getElementById('todayLeads').innerText = todayCount;
        }

        function filterLeads(query) {
            const q = query.toLowerCase();
            const filtered = allLeads.filter(l =>
                (l.name || l.fullName || '').toLowerCase().includes(q) ||
                (String(l.phone || l.phoneNumber || '')).includes(q) ||
                (l.city || '').toLowerCase().includes(q)
            );
            renderLeads(filtered);
        }

        function toggleStatus(id) {
            allLeads = allLeads.map(l => {
                if (l.id === id) {
                    return { ...l, status: l.status === 'جديد' ? 'تم التواصل' : 'جديد' };
                }
                return l;
            });
            localStorage.setItem('clients', JSON.stringify(allLeads));
            renderLeads(allLeads);
        }

        function clearLeads() {
            if (confirm('هل أنت متأكد من مسح جميع الطلبات؟')) {
                localStorage.removeItem('clients');
                loadLeads();
            }
        }

        function exportJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allLeads, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "laura_vital_leads.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
    </script>
</body>

</html>